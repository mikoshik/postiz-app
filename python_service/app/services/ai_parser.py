"""
AI –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π.
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ —Å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏.
"""
import json
from typing import Dict, Any, List, Optional
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, SystemMessage
from app.config.settings import OPENAI_API_KEY


# –®–∞–±–ª–æ–Ω –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è
DESCRIPTION_TEMPLATE = """
–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ {car_details}

–ì–æ—Ç–æ–≤—ã –Ω–∞ –ª—é–±—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, –∑–≤–æ–Ω–∏—Ç–µ –∏ –ø–∏—à–∏—Ç–µ!

–í—Å–µ –≤–∏–¥–µ–æ–æ–±–∑–æ—Ä—ã –∞–≤—Ç–æ–º–æ–±–∏–ª—è –≤ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º–µ - @rvm_auto.md

Toate recenziile video ale ma»ôinii pe Instagram - @rvm_auto.md

CREDIT - –≤–æ–∑–º–æ–∂–Ω–æ!
–î–ª—è —ç—Ç–æ–≥–æ –≤–∞–º –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –≤–∞—à–µ–≥–æ –ø–∞—Å–ø–æ—Ä—Ç–∞ (–æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã). –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º—ã —Å–º–æ–∂–µ–º —É–∑–Ω–∞—Ç—å, –±—É–¥–µ—Ç –ª–∏ –≤–∞–º –æ–¥–æ–±—Ä–µ–Ω –∫—Ä–µ–¥–∏—Ç.

Adresa parcare auto - Bugeac, Pavlova 1A

Instagram: rvm_auto.md
Facebook: RVM AUTO
TikTok: RVM AUTO
""".strip()


# –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –ø–æ–ª–µ–π —Å –æ—Å–æ–±–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
SPECIFIC_PROMPTS = {
    # –û–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (id=13)
    "description": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ò–∑–≤–ª–µ—á—å –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏ –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞—Ö.

–ß–¢–û –ò–°–ö–ê–¢–¨:
1. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ (–∑–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞, —Ñ–∏–ª—å—Ç—Ä–æ–≤, —Ç–æ—Ä–º–æ–∑–æ–≤ –∏ —Ç.–¥.)
2. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–º–æ–Ω—Ç–∞—Ö –∏ –∑–∞–º–µ–Ω–∞—Ö –¥–µ—Ç–∞–ª–µ–π
3. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∫—É–∑–æ–≤–∞, —Å–∞–ª–æ–Ω–∞, –¥–≤–∏–≥–∞—Ç–µ–ª—è
4. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏
5. –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –¥–µ—Ç–∞–ª–∏ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è

–ü–†–ê–í–ò–õ–ê:
1. –ò–∑–≤–ª–µ–∫–∏ –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞—Ö —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º
2. –ù–ï –≤–∫–ª—é—á–∞–π —Ü–µ–Ω—É, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∞–¥—Ä–µ—Å–∞
3. –°—Ñ–æ—Ä–º–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
4. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"car_details": "—Ç–µ–∫—Å—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞—Ö"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"car_details": ""}}
""",

    # –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è SEO (id=1404)
    "seo_description": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ SEO-–æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è.

–§–û–†–ú–ê–¢:
–ú–∞—Ä–∫–∞ –ú–æ–¥–µ–ª—å, –ì–æ–¥, –î–≤–∏–≥–∞—Ç–µ–ª—å, –ö–ü–ü, –ü—Ä–æ–±–µ–≥, –ü—Ä–∏–≤–æ–¥, –¶–µ–Ω–∞, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (–æ–±–º–µ–Ω/–∫—Ä–µ–¥–∏—Ç)

–ü–†–ò–ú–ï–†:
"Kia Sportage, 2016, 1.7 –¥–∏–∑–µ–ª—å, –∞–≤—Ç–æ–º–∞—Ç, 73 000 –∫–º, –ø–µ—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–≤–æ–¥, 16 900 ‚Ç¨, –æ–±–º–µ–Ω, –∫—Ä–µ–¥–∏—Ç"

–ü–†–ê–í–ò–õ–ê:
1. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ç–µ–∫—Å—Ç–∞
2. –ö—Ä–∞—Ç–∫–æ—Å—Ç—å ‚Äî –Ω–µ –±–æ–ª–µ–µ 100 —Å–∏–º–≤–æ–ª–æ–≤
3. –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"}}
""",

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (id=12)
    "title": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è.

–§–û–†–ú–ê–¢:
–ú–∞—Ä–∫–∞ –ú–æ–¥–µ–ª—å –ì–æ–¥

–ü–†–ò–ú–ï–†:
"Kia Sportage 2016"

–ü–†–ê–í–ò–õ–ê:
1. –¢–æ–ª—å–∫–æ –º–∞—Ä–∫–∞, –º–æ–¥–µ–ª—å –∏ –≥–æ–¥
2. –ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤ –∏ —Å–∏–º–≤–æ–ª–æ–≤

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "–∑–∞–≥–æ–ª–æ–≤–æ–∫"}}
"""
}


# –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π
PROMPTS = {
    "drop_down_options": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}" –∏ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ options.

–ü–†–ê–í–ò–õ–ê:
1. –í—ã–±–∏—Ä–∞–π –¢–û–õ–¨–ö–û –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ options
2. –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç ‚Äî –∏—â–∏ –ø–æ—Ö–æ–∂–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
3. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ –∏–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "–Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞", "label_id": "id –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": "", "label_id": ""}}
""",

    "textbox_text": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}".

–ü–†–ê–í–ò–õ–ê:
1. –ò–∑–≤–ª–µ–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ç–µ–∫—Å—Ç–∞
2. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "–Ω–∞–π–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": ""}}
""",

    "textarea_text": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –∏–ª–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}".

–ü–†–ê–í–ò–õ–ê:
1. –î–ª—è –ø–æ–ª—è "–û–ø–∏—Å–∞–Ω–∏–µ" ‚Äî –∏–∑–≤–ª–µ–∫–∏ –∏–ª–∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –æ–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏–∑ —Ç–µ–∫—Å—Ç–∞
2. –î–ª—è –ø–æ–ª—è "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è" ‚Äî —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ú–∞—Ä–∫–∞ –ú–æ–¥–µ–ª—å –ì–æ–¥)
3. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "—Ç–µ–∫—Å—Ç"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": ""}}
""",

    "textbox_numeric": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}".

–ü–†–ê–í–ò–õ–ê:
1. –ò–∑–≤–ª–µ–∫–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ü–∏—Ñ—Ä—ã)
2. –£–±–µ—Ä–∏ –≤—Å–µ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã, –ø—Ä–æ–±–µ–ª—ã, –≤–∞–ª—é—Ç—ã
3. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "—á–∏—Å–ª–æ"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": ""}}
""",

    "textbox_numeric_measurement": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}".

–ü–†–ê–í–ò–õ–ê:
1. –ò–∑–≤–ª–µ–∫–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ü–∏—Ñ—Ä—ã)
2. –£–±–µ—Ä–∏ –≤—Å–µ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã, –ø—Ä–æ–±–µ–ª—ã, –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
3. –î–ª—è —Ü–µ–Ω—ã ‚Äî —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –±–µ–∑ –≤–∞–ª—é—Ç—ã
4. –î–ª—è –ø—Ä–æ–±–µ–≥–∞ ‚Äî —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –±–µ–∑ "–∫–º" –∏–ª–∏ "mi"
5. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "—á–∏—Å–ª–æ"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": ""}}
"""
}

# –ú–∞–ø–ø–∏–Ω–≥ ID –ø–æ–ª–µ–π –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
FIELD_SPECIFIC_MAPPING = {
    "13": "description",      # –û–ø–∏—Å–∞–Ω–∏–µ
    "12": "title",            # –ó–∞–≥–æ–ª–æ–≤–æ–∫
    "1404": "seo_description" # SEO –æ–ø–∏—Å–∞–Ω–∏–µ
}

# –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∫–æ–ª–µ–Ω–∏—è
GENERATION_DETECTION_PROMPT = """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–∫–æ–ª–µ–Ω–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ VIN-–∫–æ–¥—É –∏ –≥–æ–¥—É –≤—ã–ø—É—Å–∫–∞.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
- VIN-–∫–æ–¥: {vin}
- –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: {year}
- –ú–∞—Ä–∫–∞: {make}
- –ú–æ–¥–µ–ª—å: {model}

–î–û–°–¢–£–ü–ù–´–ï –ü–û–ö–û–õ–ï–ù–ò–Ø:
{generations}

–ü–†–ê–í–ò–õ–ê:
1. –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω –≥–æ–¥–æ–≤ –ø–æ–∫–æ–ª–µ–Ω–∏—è (year_from - year_to)
2. –ï—Å–ª–∏ –≥–æ–¥ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ ‚Äî –≤—ã–±–∏—Ä–∞–π –±–æ–ª–µ–µ –Ω–æ–≤–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ
3. VIN-–∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ–¥–µ (—Å–∏–º–≤–æ–ª 10)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "–Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è", "label_id": "id –ø–æ–∫–æ–ª–µ–Ω–∏—è"}}

–ï—Å–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å:
{{"label": "", "label_id": ""}}
"""


class AIParserService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è AI –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ –æ–¥–Ω–æ–º—É –ø–æ–ª—é."""

    def __init__(self):
        self.llm = ChatOpenAI(
            model="gpt-4o-mini",
            temperature=0,
            api_key=OPENAI_API_KEY
        )

    def parse_single_field(
        self,
        text: str,
        field: Dict[str, Any],
        options: Optional[List[Dict]] = None,
        use_specific: bool = True
    ) -> Dict[str, Any]:
        """
        –ü–∞—Ä—Å–∏—Ç –æ–¥–Ω–æ –ø–æ–ª–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è.
        
        Args:
            text: –¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è
            field: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—è (id, title, type, options)
            options: –û–ø—Ü–∏–∏ –¥–ª—è –∑–∞–≤–∏—Å–∏–º—ã—Ö –ø–æ–ª–µ–π (–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API)
            use_specific: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –æ—Å–æ–±—ã—Ö –ø–æ–ª–µ–π
        
        Returns:
            {"label": "...", "label_id": "..."} –∏–ª–∏ {"label": ""}
        """
        field_id = str(field.get("id", ""))
        field_title = field.get("title", "")
        field_type = field.get("type", "textbox_text")
        field_options = options or field.get("options", [])
        
        print(f"üîç –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª—è: {field_title} (ID: {field_id}, Type: {field_type})")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—è
        specific_key = FIELD_SPECIFIC_MAPPING.get(field_id)
        
        if use_specific and specific_key:
            return self._parse_specific_field(text, field_id, specific_key)
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç–∏–ø–∞ –ø–æ–ª—è
            prompt_template = PROMPTS.get(field_type, PROMPTS["textbox_text"])
            system_prompt = prompt_template.format(field_title=field_title)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_message = f"–¢–ï–ö–°–¢ –û–ë–™–Ø–í–õ–ï–ù–ò–Ø:\n{text}"
            
            # –î–æ–±–∞–≤–ª—è–µ–º options –¥–ª—è dropdown
            if field_type == "drop_down_options" and field_options:
                options_text = json.dumps(
                    [{"id": str(o.get("id")), "title": o.get("title") or o.get("name", "")} 
                     for o in field_options],
                    ensure_ascii=False
                )
                user_message += f"\n\nOPTIONS:\n{options_text}"
            
            # –í—ã–∑–æ–≤ LLM
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_message)
            ]
            
            response = self.llm.invoke(messages)
            output = response.content
            
            # –û—á–∏—Å—Ç–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ JSON
            result_text = self._clean_json_response(output)
            result = json.loads(result_text)
            
            print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è {field_title}: {result}")
            return result
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ–ª—è {field_title}: {str(e)}")
            return {"label": "", "label_id": ""} if field_type == "drop_down_options" else {"label": ""}

    def _parse_specific_field(
        self,
        text: str,
        field_id: str,
        specific_key: str
    ) -> Dict[str, Any]:
        """
        –ü–∞—Ä—Å–∏—Ç –ø–æ–ª–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.
        
        Args:
            text: –¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è
            field_id: ID –ø–æ–ª—è
            specific_key: –ö–ª—é—á —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
        
        Returns:
            {"label": "..."} —Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
        """
        print(f"üéØ –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—è ID={field_id} ({specific_key})")
        
        try:
            specific_prompt = SPECIFIC_PROMPTS.get(specific_key)
            if not specific_prompt:
                return {"label": ""}
            
            messages = [
                SystemMessage(content=specific_prompt),
                HumanMessage(content=f"–¢–ï–ö–°–¢ –û–ë–™–Ø–í–õ–ï–ù–ò–Ø:\n{text}")
            ]
            
            response = self.llm.invoke(messages)
            output = response.content
            
            result_text = self._clean_json_response(output)
            result = json.loads(result_text)
            
            # –î–ª—è –æ–ø–∏—Å–∞–Ω–∏—è (id=13) –ø—Ä–∏–º–µ–Ω—è–µ–º —à–∞–±–ª–æ–Ω
            if specific_key == "description" and result.get("car_details"):
                car_details = result["car_details"]
                full_description = DESCRIPTION_TEMPLATE.format(car_details=car_details)
                result = {"label": full_description}
                print(f"üìù –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ —à–∞–±–ª–æ–Ω—É")
            
            print(f"‚úÖ –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {str(result)[:100]}...")
            return result
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞: {str(e)}")
            return {"label": ""}

    def generate_description_from_template(
        self,
        car_details: str
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ —à–∞–±–ª–æ–Ω—É.
        
        Args:
            car_details: –î–µ—Ç–∞–ª–∏ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
        
        Returns:
            –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ —à–∞–±–ª–æ–Ω—É
        """
        if not car_details:
            car_details = "–∞–≤—Ç–æ–º–æ–±–∏–ª—è"
        
        return DESCRIPTION_TEMPLATE.format(car_details=car_details)

    def detect_generation(
        self,
        vin: str,
        year: int,
        make: str,
        model: str,
        generations: List[Dict[str, Any]]
    ) -> Dict[str, Any]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ VIN-–∫–æ–¥—É –∏ –≥–æ–¥—É.
        
        Args:
            vin: VIN-–∫–æ–¥ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
            year: –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞
            make: –ú–∞—Ä–∫–∞
            model: –ú–æ–¥–µ–ª—å
            generations: –°–ø–∏—Å–æ–∫ –ø–æ–∫–æ–ª–µ–Ω–∏–π –∏–∑ API
        
        Returns:
            {"label": "–Ω–∞–∑–≤–∞–Ω–∏–µ", "label_id": "id"}
        """
        print(f"üöó –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è: {make} {model} {year}")
        
        try:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ–∫–æ–ª–µ–Ω–∏—è
            generations_text = json.dumps(generations, ensure_ascii=False, indent=2)
            
            prompt = GENERATION_DETECTION_PROMPT.format(
                vin=vin or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                year=year or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                make=make or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                model=model or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                generations=generations_text
            )
            
            messages = [
                SystemMessage(content=prompt),
                HumanMessage(content="–û–ø—Ä–µ–¥–µ–ª–∏ –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è.")
            ]
            
            response = self.llm.invoke(messages)
            output = response.content
            
            result_text = self._clean_json_response(output)
            result = json.loads(result_text)
            
            print(f"üéØ –ü–æ–∫–æ–ª–µ–Ω–∏–µ: {result}")
            return result
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∫–æ–ª–µ–Ω–∏—è: {str(e)}")
            return {"label": "", "label_id": ""}

    def translate_russian_to_romanian(self, text: str) -> str:
        """
        –ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ —Ä—É–º—ã–Ω—Å–∫–∏–π.
        
        Args:
            text: –¢–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º
        
        Returns:
            –¢–µ–∫—Å—Ç –Ω–∞ —Ä—É–º—ã–Ω—Å–∫–æ–º
        """
        print("üåê –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ —Ä—É–º—ã–Ω—Å–∫–∏–π")
        
        try:
            messages = [
                SystemMessage(content="–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫. –ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ —Ä—É–º—ã–Ω—Å–∫–∏–π. –°–æ—Ö—Ä–∞–Ω–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ–∫—Å—Ç–∞."),
                HumanMessage(content=text)
            ]
            
            response = self.llm.invoke(messages)
            output = response.content
            
            print("‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω")
            return output.strip()
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {str(e)}")
            return ""

    def _clean_json_response(self, text: str) -> str:
        """–û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤."""
        if "```json" in text:
            text = text.split("```json")[1].split("```")[0].strip()
        elif "```" in text:
            text = text.split("```")[1].split("```")[0].strip()
        return text.strip()


# Singleton instance
ai_parser_service = AIParserService()
