"""
AI –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π.
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ —Å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏.
"""
import json
from typing import Dict, Any, List, Optional
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, SystemMessage
from app.config.settings import OPENAI_API_KEY


# –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π
PROMPTS = {
    "drop_down_options": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}" –∏ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ options.

–ü–†–ê–í–ò–õ–ê:
1. –í—ã–±–∏—Ä–∞–π –¢–û–õ–¨–ö–û –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ options
2. –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç ‚Äî –∏—â–∏ –ø–æ—Ö–æ–∂–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
3. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–µ–∫—Å—Ç–µ –∏–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "–Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞", "label_id": "id –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": "", "label_id": ""}}
""",

    "textbox_text": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}".

–ü–†–ê–í–ò–õ–ê:
1. –ò–∑–≤–ª–µ–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ç–µ–∫—Å—Ç–∞
2. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "–Ω–∞–π–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": ""}}
""",

    "textarea_text": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –∏–ª–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}".

–ü–†–ê–í–ò–õ–ê:
1. –î–ª—è –ø–æ–ª—è "–û–ø–∏—Å–∞–Ω–∏–µ" ‚Äî –∏–∑–≤–ª–µ–∫–∏ –∏–ª–∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –æ–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏–∑ —Ç–µ–∫—Å—Ç–∞
2. –î–ª—è –ø–æ–ª—è "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è" ‚Äî —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ú–∞—Ä–∫–∞ –ú–æ–¥–µ–ª—å –ì–æ–¥)
3. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "—Ç–µ–∫—Å—Ç"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": ""}}
""",

    "textbox_numeric": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}".

–ü–†–ê–í–ò–õ–ê:
1. –ò–∑–≤–ª–µ–∫–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ü–∏—Ñ—Ä—ã)
2. –£–±–µ—Ä–∏ –≤—Å–µ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã, –ø—Ä–æ–±–µ–ª—ã, –≤–∞–ª—é—Ç—ã
3. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "—á–∏—Å–ª–æ"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": ""}}
""",

    "textbox_numeric_measurement": """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ù–∞–π—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "{field_title}".

–ü–†–ê–í–ò–õ–ê:
1. –ò–∑–≤–ª–µ–∫–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ü–∏—Ñ—Ä—ã)
2. –£–±–µ—Ä–∏ –≤—Å–µ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã, –ø—Ä–æ–±–µ–ª—ã, –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
3. –î–ª—è —Ü–µ–Ω—ã ‚Äî —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –±–µ–∑ –≤–∞–ª—é—Ç—ã
4. –î–ª—è –ø—Ä–æ–±–µ–≥–∞ ‚Äî —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –±–µ–∑ "–∫–º" –∏–ª–∏ "mi"
5. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "—á–∏—Å–ª–æ"}}

–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
{{"label": ""}}
"""
}

# –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∫–æ–ª–µ–Ω–∏—è
GENERATION_DETECTION_PROMPT = """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–∫–æ–ª–µ–Ω–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ VIN-–∫–æ–¥—É –∏ –≥–æ–¥—É –≤—ã–ø—É—Å–∫–∞.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
- VIN-–∫–æ–¥: {vin}
- –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: {year}
- –ú–∞—Ä–∫–∞: {make}
- –ú–æ–¥–µ–ª—å: {model}

–î–û–°–¢–£–ü–ù–´–ï –ü–û–ö–û–õ–ï–ù–ò–Ø:
{generations}

–ü–†–ê–í–ò–õ–ê:
1. –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω –≥–æ–¥–æ–≤ –ø–æ–∫–æ–ª–µ–Ω–∏—è (year_from - year_to)
2. –ï—Å–ª–∏ –≥–æ–¥ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ ‚Äî –≤—ã–±–∏—Ä–∞–π –±–æ–ª–µ–µ –Ω–æ–≤–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ
3. VIN-–∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ–¥–µ (—Å–∏–º–≤–æ–ª 10)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):
{{"label": "–Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è", "label_id": "id –ø–æ–∫–æ–ª–µ–Ω–∏—è"}}

–ï—Å–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å:
{{"label": "", "label_id": ""}}
"""


class AIParserService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è AI –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ –æ–¥–Ω–æ–º—É –ø–æ–ª—é."""

    def __init__(self):
        self.llm = ChatOpenAI(
            model="gpt-4o-mini",
            temperature=0,
            api_key=OPENAI_API_KEY
        )

    def parse_single_field(
        self,
        text: str,
        field: Dict[str, Any],
        options: Optional[List[Dict]] = None
    ) -> Dict[str, Any]:
        """
        –ü–∞—Ä—Å–∏—Ç –æ–¥–Ω–æ –ø–æ–ª–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è.
        
        Args:
            text: –¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è
            field: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—è (id, title, type, options)
            options: –û–ø—Ü–∏–∏ –¥–ª—è –∑–∞–≤–∏—Å–∏–º—ã—Ö –ø–æ–ª–µ–π (–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API)
        
        Returns:
            {"label": "...", "label_id": "..."} –∏–ª–∏ {"label": ""}
        """
        field_id = str(field.get("id", ""))
        field_title = field.get("title", "")
        field_type = field.get("type", "textbox_text")
        field_options = options or field.get("options", [])
        
        print(f"üîç –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª—è: {field_title} (ID: {field_id}, Type: {field_type})")
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç–∏–ø–∞ –ø–æ–ª—è
            prompt_template = PROMPTS.get(field_type, PROMPTS["textbox_text"])
            system_prompt = prompt_template.format(field_title=field_title)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_message = f"–¢–ï–ö–°–¢ –û–ë–™–Ø–í–õ–ï–ù–ò–Ø:\n{text}"
            
            # –î–æ–±–∞–≤–ª—è–µ–º options –¥–ª—è dropdown
            if field_type == "drop_down_options" and field_options:
                options_text = json.dumps(
                    [{"id": str(o.get("id")), "title": o.get("title") or o.get("name", "")} 
                     for o in field_options],
                    ensure_ascii=False
                )
                user_message += f"\n\nOPTIONS:\n{options_text}"
            
            # –í—ã–∑–æ–≤ LLM
            messages = [
                SystemMessage(content=system_prompt),
                HumanMessage(content=user_message)
            ]
            
            response = self.llm.invoke(messages)
            output = response.content
            
            # –û—á–∏—Å—Ç–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ JSON
            result_text = self._clean_json_response(output)
            result = json.loads(result_text)
            
            print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è {field_title}: {result}")
            return result
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ–ª—è {field_title}: {str(e)}")
            return {"label": "", "label_id": ""} if field_type == "drop_down_options" else {"label": ""}

    def detect_generation(
        self,
        vin: str,
        year: int,
        make: str,
        model: str,
        generations: List[Dict[str, Any]]
    ) -> Dict[str, Any]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ VIN-–∫–æ–¥—É –∏ –≥–æ–¥—É.
        
        Args:
            vin: VIN-–∫–æ–¥ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
            year: –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞
            make: –ú–∞—Ä–∫–∞
            model: –ú–æ–¥–µ–ª—å
            generations: –°–ø–∏—Å–æ–∫ –ø–æ–∫–æ–ª–µ–Ω–∏–π –∏–∑ API
        
        Returns:
            {"label": "–Ω–∞–∑–≤–∞–Ω–∏–µ", "label_id": "id"}
        """
        print(f"üöó –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è: {make} {model} {year}")
        
        try:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ–∫–æ–ª–µ–Ω–∏—è
            generations_text = json.dumps(generations, ensure_ascii=False, indent=2)
            
            prompt = GENERATION_DETECTION_PROMPT.format(
                vin=vin or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                year=year or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                make=make or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                model=model or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                generations=generations_text
            )
            
            messages = [
                SystemMessage(content=prompt),
                HumanMessage(content="–û–ø—Ä–µ–¥–µ–ª–∏ –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è.")
            ]
            
            response = self.llm.invoke(messages)
            output = response.content
            
            result_text = self._clean_json_response(output)
            result = json.loads(result_text)
            
            print(f"üéØ –ü–æ–∫–æ–ª–µ–Ω–∏–µ: {result}")
            return result
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∫–æ–ª–µ–Ω–∏—è: {str(e)}")
            return {"label": "", "label_id": ""}

    def _clean_json_response(self, text: str) -> str:
        """–û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤."""
        if "```json" in text:
            text = text.split("```json")[1].split("```")[0].strip()
        elif "```" in text:
            text = text.split("```")[1].split("```")[0].strip()
        return text.strip()


# Singleton instance
ai_parser_service = AIParserService()
