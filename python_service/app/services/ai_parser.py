"""
AI –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π.
"""
import json
import re
from typing import Dict, Any, List
from langchain_openai import ChatOpenAI
from langchain.agents import create_agent
from langchain_core.messages import HumanMessage, SystemMessage
from .ai_tools import search_car_generations
from app.config.settings import OPENAI_API_KEY


# –ü—Ä–æ–º–ø—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å –≥–æ—Ç–æ–≤–æ–π —Å—Ö–µ–º–æ–π –ø–æ–ª–µ–π
SCHEMA_BASED_PROMPT = """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ –ø—Ä–æ–¥–∞–∂–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —Å—Ö–µ–º–µ –ø–æ–ª–µ–π.

–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
1. –¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –°—Ö–µ–º–∞ –ø–æ–ª–µ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –≥–¥–µ:
   - –ö–ª—é—á = –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "make", "model", "year")
   - –ó–Ω–∞—á–µ–Ω–∏–µ = –æ–±—ä–µ–∫—Ç —Å "value" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è) –∏ "options" (—Å–ø–∏—Å–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
   - –ò–õ–ò –ø—Ä–æ—Å—Ç–æ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ "" –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö/—á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

–ü–†–ê–í–ò–õ–ê –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø:

1. **–ü–æ–ª—è —Å options (–≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫)**:
   - –í—ã–±–∏—Ä–∞–π –¢–û–õ–¨–ö–û –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ options
   - –í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–ß–ù–û–ï –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ (—Å —É—á—ë—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞)
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–∫–∞–∑–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ ‚Äî –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É ""
   - –ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ options = ["BMW", "Audi", "Mercedes"], –∞ –≤ —Ç–µ–∫—Å—Ç–µ "–±–º–≤" ‚Üí –≤–µ—Ä–Ω–∏ "BMW"

2. **–¢–µ–∫—Å—Ç–æ–≤—ã–µ/—á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è (–±–µ–∑ options)**:
   - –ò–∑–≤–ª–µ–∫–∞–π –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ç–µ–∫—Å—Ç–∞
   - –î–ª—è —á–∏—Å–µ–ª ‚Äî —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: "2020", "50000", "25000")
   - –î–ª—è —Ç–µ–∫—Å—Ç–∞ ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

3. **–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç**:
   - –í–æ–∑–≤—Ä–∞—â–∞–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É ""
   - –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ

4. **–û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏**:
   - –ú–∞—Ä–∫–∞/–º–æ–¥–µ–ª—å: –∏—â–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –±—Ä–µ–Ω–¥–æ–≤ –∏ –º–æ–¥–µ–ª–µ–π –∞–≤—Ç–æ
   - –ì–æ–¥: 4-–∑–Ω–∞—á–Ω–æ–µ —á–∏—Å–ª–æ (1990-2025)
   - –¶–µ–Ω–∞: —á–∏—Å–ª–æ –±–µ–∑ –≤–∞–ª—é—Ç—ã
   - –ü—Ä–æ–±–µ–≥: —á–∏—Å–ª–æ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö
   - –û–±—ä—ë–º –¥–≤–∏–≥–∞—Ç–µ–ª—è: –∏—â–∏ —Ñ–æ—Ä–º–∞—Ç "X.X –ª" –∏–ª–∏ "XXXXcc"
   - –ö–ü–ü: "–∞–≤—Ç–æ–º–∞—Ç"/"–º–µ—Ö–∞–Ω–∏–∫–∞"/"–≤–∞—Ä–∏–∞—Ç–æ—Ä"/"—Ä–æ–±–æ—Ç"
   - –¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞: –±–µ–Ω–∑–∏–Ω/–¥–∏–∑–µ–ª—å/–≥–∞–∑/—ç–ª–µ–∫—Ç—Ä–æ/–≥–∏–±—Ä–∏–¥

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –æ–±—ä–µ–∫—Ç —Å —Ç–µ–º–∏ –∂–µ –∫–ª—é—á–∞–º–∏, —á—Ç–æ –∏ –≤–æ –≤—Ö–æ–¥–Ω–æ–π —Å—Ö–µ–º–µ.
–ó–Ω–∞—á–µ–Ω–∏—è ‚Äî —ç—Ç–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.

–ü—Ä–∏–º–µ—Ä –≤—Ö–æ–¥–Ω–æ–π —Å—Ö–µ–º—ã:
{
    "make": {"value": "", "options": ["BMW", "Audi", "Mercedes"]},
    "model": "",
    "year": "",
    "price": "",
    "mileage": "",
    "transmission": {"value": "", "options": ["–ê–≤—Ç–æ–º–∞—Ç", "–ú–µ—Ö–∞–Ω–∏–∫–∞", "–í–∞—Ä–∏–∞—Ç–æ—Ä"]}
}

–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞: "–ü—Ä–æ–¥–∞—é –ë–ú–í X5 2020 –≥–æ–¥–∞, –∞–≤—Ç–æ–º–∞—Ç, –ø—Ä–æ–±–µ–≥ 45000 –∫–º, —Ü–µ–Ω–∞ 25000 –µ–≤—Ä–æ"

–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
{
    "make": "BMW",
    "model": "X5",
    "year": "2020",
    "price": "25000",
    "mileage": "45000",
    "transmission": "–ê–≤—Ç–æ–º–∞—Ç"
}
"""

GENERATION_DETECTION_PROMPT = """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–∫–æ–ª–µ–Ω–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ VIN-–∫–æ–¥—É –∏ –≥–æ–¥—É –≤—ã–ø—É—Å–∫–∞.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
1. VIN-–∫–æ–¥ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (17 —Å–∏–º–≤–æ–ª–æ–≤)
2. –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞
3. –ú–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
4. –ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è
5. –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–∫–æ–ª–µ–Ω–∏–π —Å –≥–æ–¥–∞–º–∏ –≤—ã–ø—É—Å–∫–∞

–ö–ê–ö –û–ü–†–ï–î–ï–õ–ò–¢–¨ –ü–û–ö–û–õ–ï–ù–ò–ï:

1. **–ê–Ω–∞–ª–∏–∑ VIN-–∫–æ–¥–∞**:
   - –°–∏–º–≤–æ–ª—ã 1-3 (WMI): –∫–æ–¥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –∏ —Å—Ç—Ä–∞–Ω—ã
   - –°–∏–º–≤–æ–ª—ã 4-8 (VDS): –æ–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–º–æ–¥–µ–ª—å, —Ç–∏–ø –∫—É–∑–æ–≤–∞, –¥–≤–∏–≥–∞—Ç–µ–ª—å)
   - –°–∏–º–≤–æ–ª 9: –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ü–∏—Ñ—Ä–∞
   - –°–∏–º–≤–æ–ª 10: –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞ (A=1980, B=1981... Y=2000, 1=2001... 9=2009, A=2010...)
   - –°–∏–º–≤–æ–ª—ã 11-17: —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä

2. **–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≥–æ–¥–∞**:
   - –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω –≥–æ–¥–æ–≤ –ø–æ–∫–æ–ª–µ–Ω–∏—è
   - –£—á–∏—Ç—ã–≤–∞–π, —á—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–µ –≥–æ–¥—ã –º–æ–≥—É—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –æ–±–æ–∏–º –ø–æ–∫–æ–ª–µ–Ω–∏—è–º

3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã**:
   - VIN-–∫–æ–¥ –∏–º–µ–µ—Ç –≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫–æ–ª–µ–Ω–∏–∏)
   - –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ ‚Äî –≤—Ç–æ—Ä–æ–π –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏
   - –ï—Å–ª–∏ –≥–æ–¥ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ –¥–≤—É—Ö –ø–æ–∫–æ–ª–µ–Ω–∏–π ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π VIN –¥–µ—Ç–∞–ª—å–Ω–µ–µ

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –æ–±—ä–µ–∫—Ç:
{
    "generation_id": "ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞",
    "generation_name": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è",
    "confidence": 0.95,
    "reasoning": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞"
}

–ï—Å–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–∫–æ–ª–µ–Ω–∏–µ ‚Äî –≤–µ—Ä–Ω–∏:
{
    "generation_id": null,
    "generation_name": null,
    "confidence": 0,
    "reasoning": "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è"
}
"""


class AIParserService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è AI –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π."""

    def __init__(self):
        self.agent = create_agent(
            model=ChatOpenAI(
                model="gpt-4o",
                temperature=0,
                api_key=OPENAI_API_KEY
            ),
            # tools=[search_car_generations],
            system_prompt=SystemMessage(content=SCHEMA_BASED_PROMPT),
        )

    def parse_with_schema(self, text: str, schema: dict) -> dict:
        """–ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é —Å—Ö–µ–º—É –ø–æ–ª–µ–π."""
        try:
            user_message = f"""
    –¢–ï–ö–°–¢ –û–ë–™–Ø–í–õ–ï–ù–ò–Ø:
    {text}

    –°–•–ï–ú–ê –ü–û–õ–ï–ô –î–õ–Ø –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø:
    {json.dumps(schema, ensure_ascii=False, indent=2)}

    –ó–∞–ø–æ–ª–Ω–∏ —Å—Ö–µ–º—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON.
    """
            
            # Pass a list of messages - not a single message
            response = self.agent.invoke({
                "messages": [{"role": "user", "content": user_message}]
            })
            
            # Extract content from response dict
            output = response["messages"][-1].content  # Get last message content
            
            # Clean JSON
            result_text = self._clean_json_response(output)
            result = json.loads(result_text)
            
            print(f"ü§ñ AI Schema Parse Result: {result}")
            return result
            
        except Exception as e:
            print(f"‚ùå AI Schema Parse Error: {str(e)}")
            import traceback
            traceback.print_exc()
            return {}
        
    def detect_generation(
        self,
        vin: str,
        year: int,
        make: str,
        model: str,
        generations: List[Dict[str, Any]]
    ) -> Dict[str, Any]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ VIN-–∫–æ–¥—É –∏ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º.
        
        Args:
            vin: VIN-–∫–æ–¥ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (17 —Å–∏–º–≤–æ–ª–æ–≤)
            year: –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞
            make: –ú–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "BMW", "Toyota")
            model: –ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "X5", "Camry")
            generations: –°–ø–∏—Å–æ–∫ –ø–æ–∫–æ–ª–µ–Ω–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏:
                [
                    {
                        "id": "gen_123",
                        "name": "E70",
                        "year_from": 2006,
                        "year_to": 2013
                    },
                    ...
                ]
        
        Returns:
            {
                "generation_id": "ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è",
                "generation_name": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è",
                "confidence": 0.95,
                "reasoning": "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞"
            }
        """
        self.agent.system_prompt = SystemMessage(content=GENERATION_DETECTION_PROMPT)
        try:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–∫–æ–ª–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
            generations_text = json.dumps(generations, ensure_ascii=False, indent=2)
            
            user_message = f"""
–î–ê–ù–ù–´–ï –ê–í–¢–û–ú–û–ë–ò–õ–Ø:
- VIN-–∫–æ–¥: {vin}
- –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: {year}
- –ú–∞—Ä–∫–∞: {make}
- –ú–æ–¥–µ–ª—å: {model}

–î–û–°–¢–£–ü–ù–´–ï –ü–û–ö–û–õ–ï–ù–ò–Ø:
{generations_text}

–û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–∞–Ω–Ω–æ–º—É –∞–≤—Ç–æ–º–æ–±–∏–ª—é. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON.
"""
            
            response = self.agent.invoke({
                "messages": [{"role": "user", "content": user_message}]
            })
            output = response["messages"][-1].content
            
            # Clean JSON
            result_text = self._clean_json_response(output)
            result = json.loads(result_text)
            
            print(f"üöó AI Generation Detection Result: {result}")
            return result
            
        except Exception as e:
            print(f"‚ùå AI Generation Detection Error: {str(e)}")
            import traceback
            traceback.print_exc()
            return {
                "generation_id": None,
                "generation_name": None,
                "confidence": 0,
                "reasoning": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏: {str(e)}"
            }


    def _clean_json_response(self, text: str) -> str:
        """–û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤."""
        if "```json" in text:
            text = text.split("```json")[1].split("```")[0].strip()
        elif "```" in text:
            text = text.split("```")[1].split("```")[0].strip()
        return text

    

   
# Singleton instance
ai_parser_service = AIParserService()
